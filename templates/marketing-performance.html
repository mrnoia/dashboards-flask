{% extends "base.html" %}

{% block title %}Marketing Performance Dashboard{% endblock %}

{% block extra_css %}
<style>
    .campaign-card { cursor: pointer; transition: all 0.3s ease; }
    .campaign-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .back-btn { background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
    .back-btn:hover { background-color: #5a6268; }
    .metric-card { transition: all 0.3s ease; }
    .metric-card:hover { transform: translateY(-2px); }
    .roi-indicator { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .conversion-indicator { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
    .engagement-indicator { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .channel-pills { display: flex; gap: 8px; flex-wrap: wrap; }
    .channel-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb Navigation -->
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb" id="breadcrumb">
                    <li class="breadcrumb-item active">Marketing Overview</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card p-3 text-center metric-card roi-indicator">
                <h6 class="text-white">Total ROI</h6>
                <h2 id="total-roi" class="text-white">0%</h2>
                <small class="text-white" id="roi-change">+0%</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center metric-card">
                <h6 class="text-muted">Campaigns Active</h6>
                <h2 id="active-campaigns">0</h2>
                <small class="text-success" id="campaigns-change">+0</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center metric-card conversion-indicator">
                <h6 class="text-white">Conversion Rate</h6>
                <h2 id="conversion-rate" class="text-white">0%</h2>
                <small class="text-white" id="conversion-change">+0%</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 text-center metric-card engagement-indicator">
                <h6 class="text-white">Engagement Rate</h6>
                <h2 id="engagement-rate" class="text-white">0%</h2>
                <small class="text-white" id="engagement-change">+0%</small>
            </div>
        </div>
    </div>

    <!-- Campaign Performance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>üì¢ Campaign Performance</h5>
                    <small class="text-muted">Click on any campaign to drill down</small>
                </div>
                <div class="card-body">
                    <div id="campaigns-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Marketing Funnel -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>üéØ Marketing Funnel</h5>
                    <small class="text-muted">Customer journey through marketing stages</small>
                </div>
                <div class="card-body">
                    <div id="funnel-chart"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>üìà Trend Analysis</h5>
                    <small class="text-muted">Marketing metrics over time</small>
                </div>
                <div class="card-body">
                    <div id="trends-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Details Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5>Campaign Details</h5>
                        <small class="text-muted" id="table-subtitle">Overview of all marketing campaigns</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="exportData()">
                            üìä Export Data
                        </button>
                        <button class="btn btn-sm btn-success" onclick="createNewCampaign()">
                            ‚ûï New Campaign
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Campaign</th>
                                    <th>Channel</th>
                                    <th>Budget</th>
                                    <th>Spend</th>
                                    <th>Revenue</th>
                                    <th>ROI</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Marketing performance hierarchical data
    const marketingData = {
        overview: {
            campaigns: [
                {
                    name: 'Summer Sale 2024',
                    channel: 'Email',
                    budget: 50000,
                    spend: 45000,
                    revenue: 225000,
                    roi: 400,
                    status: 'Active',
                    startDate: '2024-06-01',
                    endDate: '2024-08-31',
                    details: {
                        audience: {
                            size: 250000,
                            targeted: 50000,
                            reached: 45000
                        },
                        performance: {
                            opens: 85,
                            clicks: 12,
                            conversions: 3.2,
                            bounceRate: 2.1
                        },
                        timeline: [
                            { date: '2024-06-01', impressions: 10000, clicks: 1200, conversions: 38 },
                            { date: '2024-06-15', impressions: 12000, clicks: 1440, conversions: 46 },
                            { date: '2024-07-01', impressions: 15000, clicks: 1800, conversions: 58 },
                            { date: '2024-07-15', impressions: 18000, clicks: 2160, conversions: 69 },
                            { date: '2024-08-01', impressions: 20000, clicks: 2400, conversions: 77 },
                            { date: '2024-08-15', impressions: 22000, clicks: 2640, conversions: 85 }
                        ]
                    }
                },
                {
                    name: 'Social Media Blitz',
                    channel: 'Social',
                    budget: 75000,
                    spend: 68000,
                    revenue: 272000,
                    roi: 300,
                    status: 'Active',
                    startDate: '2024-05-15',
                    endDate: '2024-09-15',
                    details: {
                        audience: {
                            size: 500000,
                            targeted: 100000,
                            reached: 85000
                        },
                        performance: {
                            impressions: 2500000,
                            engagement: 8.5,
                            clicks: 4.2,
                            conversions: 2.8
                        },
                        timeline: [
                            { date: '2024-05-15', impressions: 400000, clicks: 16800, conversions: 112 },
                            { date: '2024-06-01', impressions: 450000, clicks: 18900, conversions: 126 },
                            { date: '2024-06-15', impressions: 420000, clicks: 17640, conversions: 118 },
                            { date: '2024-07-01', impressions: 480000, clicks: 20160, conversions: 134 },
                            { date: '2024-07-15', impressions: 520000, clicks: 21840, conversions: 146 },
                            { date: '2024-08-01', impressions: 550000, clicks: 23100, conversions: 154 }
                        ]
                    }
                },
                {
                    name: 'Google Ads Q3',
                    channel: 'Search',
                    budget: 100000,
                    spend: 92000,
                    revenue: 414000,
                    roi: 350,
                    status: 'Active',
                    startDate: '2024-07-01',
                    endDate: '2024-09-30',
                    details: {
                        audience: {
                            size: 1000000,
                            targeted: 200000,
                            reached: 180000
                        },
                        performance: {
                            impressions: 2000000,
                            ctr: 2.8,
                            cpc: 2.5,
                            conversions: 4.5
                        },
                        timeline: [
                            { date: '2024-07-01', impressions: 650000, clicks: 18200, conversions: 819 },
                            { date: '2024-07-15', impressions: 680000, clicks: 19040, conversions: 857 },
                            { date: '2024-08-01', impressions: 700000, clicks: 19600, conversions: 882 },
                            { date: '2024-08-15', impressions: 720000, clicks: 20160, conversions: 907 },
                            { date: '2024-09-01', impressions: 750000, clicks: 21000, conversions: 945 },
                            { date: '2024-09-15', impressions: 780000, clicks: 21840, conversions: 983 }
                        ]
                    }
                },
                {
                    name: 'Content Marketing',
                    channel: 'Content',
                    budget: 30000,
                    spend: 28000,
                    revenue: 84000,
                    roi: 200,
                    status: 'Active',
                    startDate: '2024-04-01',
                    endDate: '2024-12-31',
                    details: {
                        audience: {
                            size: 300000,
                            targeted: 75000,
                            reached: 60000
                        },
                        performance: {
                            pageViews: 500000,
                            avgTimeOnPage: 180,
                            bounceRate: 35,
                            leadGen: 2.1
                        },
                        timeline: [
                            { date: '2024-04-01', pageViews: 80000, leads: 168, conversions: 17 },
                            { date: '2024-05-01', pageViews: 85000, leads: 179, conversions: 18 },
                            { date: '2024-06-01', pageViews: 90000, leads: 189, conversions: 19 },
                            { date: '2024-07-01', pageViews: 95000, leads: 200, conversions: 20 },
                            { date: '2024-08-01', pageViews: 100000, leads: 210, conversions: 21 },
                            { date: '2024-09-01', pageViews: 105000, leads: 221, conversions: 22 }
                        ]
                    }
                },
                {
                    name: 'Influencer Partnership',
                    channel: 'Influencer',
                    budget: 40000,
                    spend: 38000,
                    revenue: 152000,
                    roi: 300,
                    status: 'Completed',
                    startDate: '2024-03-01',
                    endDate: '2024-05-31',
                    details: {
                        audience: {
                            size: 800000,
                            targeted: 160000,
                            reached: 140000
                        },
                        performance: {
                            reach: 140000,
                            engagement: 12.5,
                            clicks: 6.8,
                            conversions: 3.2
                        },
                        timeline: [
                            { date: '2024-03-01', reach: 20000, engagement: 2500, clicks: 1360, conversions: 43 },
                            { date: '2024-03-15', reach: 35000, engagement: 4375, clicks: 2380, conversions: 76 },
                            { date: '2024-04-01', reach: 50000, engagement: 6250, clicks: 3400, conversions: 108 },
                            { date: '2024-04-15', reach: 65000, engagement: 8125, clicks: 4420, conversions: 141 },
                            { date: '2024-05-01', reach: 80000, engagement: 10000, clicks: 5440, conversions: 173 },
                            { date: '2024-05-15', reach: 90000, engagement: 11250, clicks: 6120, conversions: 195 }
                        ]
                    }
                }
            ]
        }
    };

    let currentView = 'overview';
    let currentCampaign = null;
    let campaignsChart, funnelChart, trendsChart;

    // Initialize dashboard
    function initDashboard() {
        updateMetrics();
        renderCampaignsChart();
        renderFunnelChart();
        renderTrendsChart();
        updateTable('overview');
    }

    // Update metrics
    function updateMetrics() {
        const campaigns = marketingData.overview.campaigns;
        const totalSpend = campaigns.reduce((sum, camp) => sum + camp.spend, 0);
        const totalRevenue = campaigns.reduce((sum, camp) => sum + camp.revenue, 0);
        const avgROI = campaigns.reduce((sum, camp) => sum + camp.roi, 0) / campaigns.length;
        const activeCampaigns = campaigns.filter(camp => camp.status === 'Active').length;
        const avgConversionRate = campaigns.reduce((sum, camp) => sum + (camp.details.performance.conversions || camp.details.performance.leadGen || 0), 0) / campaigns.length;
        const avgEngagementRate = campaigns.reduce((sum, camp) => sum + (camp.details.performance.engagement || camp.details.performance.opens || 0), 0) / campaigns.length;

        document.getElementById('total-roi').textContent = avgROI.toFixed(0) + '%';
        document.getElementById('roi-change').textContent = '+15%';
        
        document.getElementById('active-campaigns').textContent = activeCampaigns;
        document.getElementById('campaigns-change').textContent = '+2';
        
        document.getElementById('conversion-rate').textContent = avgConversionRate.toFixed(1) + '%';
        document.getElementById('conversion-change').textContent = '+0.8%';
        
        document.getElementById('engagement-rate').textContent = avgEngagementRate.toFixed(1) + '%';
        document.getElementById('engagement-change').textContent = '+2.3%';
    }

    // Render campaigns chart
    function renderCampaignsChart() {
        const campaigns = marketingData.overview.campaigns;
        
        campaignsChart = new ApexCharts(document.querySelector("#campaigns-chart"), {
            series: [{
                name: 'Budget',
                data: campaigns.map(camp => camp.budget / 1000)
            }, {
                name: 'Spend',
                data: campaigns.map(camp => camp.spend / 1000)
            }, {
                name: 'Revenue',
                data: campaigns.map(camp => camp.revenue / 1000)
            }],
            chart: {
                type: 'bar',
                height: 350,
                toolbar: {
                    show: false
                },
                events: {
                    dataPointSelection: function(event, chartContext, config) {
                        const campaignIndex = config.dataPointIndex;
                        drillToCampaign(campaigns[campaignIndex].name);
                    }
                }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '60%',
                    endingShape: 'rounded'
                },
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                categories: campaigns.map(camp => camp.name.length > 15 ? camp.name.substring(0, 15) + '...' : camp.name)
            },
            yaxis: {
                title: {
                    text: 'Amount ($K)'
                }
            },
            fill: {
                opacity: 1
            },
            tooltip: {
                y: {
                    formatter: function(value) {
                        return '$' + value + 'K';
                    }
                }
            }
        });

        campaignsChart.render();
    }

    // Render funnel chart
    function renderFunnelChart() {
        funnelChart = new ApexCharts(document.querySelector("#funnel-chart"), {
            series: [{
                name: 'Users',
                data: [
                    { x: 'Awareness', y: 1000000 },
                    { x: 'Interest', y: 750000 },
                    { x: 'Consideration', y: 500000 },
                    { x: 'Intent', y: 250000 },
                    { x: 'Evaluation', y: 100000 },
                    { x: 'Purchase', y: 50000 }
                ]
            }],
            chart: {
                type: 'bar',
                height: 350,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    borderRadius: 0,
                    horizontal: true,
                    distributed: true,
                    barHeight: '80%',
                    isFunnel: true
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function(value, { dataPointIndex }) {
                    const labels = ['100%', '75%', '50%', '25%', '10%', '5%'];
                    return labels[dataPointIndex];
                },
                dropShadow: {
                    enabled: true
                }
            },
            xaxis: {
                categories: ['Awareness', 'Interest', 'Consideration', 'Intent', 'Evaluation', 'Purchase']
            }
        });

        funnelChart.render();
    }

    // Render trends chart
    function renderTrendsChart() {
        trendsChart = new ApexCharts(document.querySelector("#trends-chart"), {
            series: [{
                name: 'ROI %',
                data: [280, 320, 350, 380, 360, 390]
            }, {
                name: 'Conversion Rate %',
                data: [2.1, 2.5, 2.8, 3.2, 3.0, 3.5]
            }, {
                name: 'Engagement Rate %',
                data: [6.5, 7.2, 8.1, 8.8, 8.3, 9.2]
            }],
            chart: {
                type: 'line',
                height: 350,
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            xaxis: {
                categories: ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep']
            },
            tooltip: {
                shared: true,
                intersect: false
            },
            legend: {
                position: 'top'
            }
        });

        trendsChart.render();
    }

    // Drill down to campaign
    function drillToCampaign(campaignName) {
        currentView = 'campaign';
        currentCampaign = marketingData.overview.campaigns.find(camp => camp.name === campaignName);

        // Update breadcrumb
        document.getElementById('breadcrumb').innerHTML = `
            <li class="breadcrumb-item"><a href="#" onclick="goBack()">Marketing Overview</a></li>
            <li class="breadcrumb-item active">${campaignName}</li>
        `;

        // Update metrics
        document.getElementById('total-roi').textContent = currentCampaign.roi + '%';
        document.getElementById('active-campaigns').textContent = '1';
        document.getElementById('conversion-rate').textContent = (currentCampaign.details.performance.conversions || currentCampaign.details.performance.leadGen || 0) + '%';
        document.getElementById('engagement-rate').textContent = (currentCampaign.details.performance.engagement || currentCampaign.details.performance.opens || 0) + '%';

        // Update charts
        renderCampaignDetailsChart();
        updateTable('campaign');
    }

    // Render campaign details chart
    function renderCampaignDetailsChart() {
        const timeline = currentCampaign.details.timeline;
        
        campaignsChart.updateOptions({
            series: [{
                name: 'Daily Performance',
                data: timeline.map(point => point.conversions)
            }],
            xaxis: {
                categories: timeline.map(point => point.date.substring(5))
            },
            chart: {
                events: {
                    dataPointSelection: null
                }
            }
        });
    }

    // Update table
    function updateTable(view) {
        const tableBody = document.getElementById('table-body');
        const tableSubtitle = document.getElementById('table-subtitle');

        if (view === 'overview') {
            tableSubtitle.textContent = 'Overview of all marketing campaigns';
            tableBody.innerHTML = marketingData.overview.campaigns.map(campaign => `
                <tr class="campaign-card" onclick="drillToCampaign('${campaign.name}')">
                    <td>
                        <strong>${campaign.name}</strong>
                        <br><small class="text-muted">Click for details</small>
                    </td>
                    <td>
                        <span class="channel-pill" style="background: ${getChannelColor(campaign.channel)}; color: white;">
                            ${campaign.channel}
                        </span>
                    </td>
                    <td>$${campaign.budget.toLocaleString()}</td>
                    <td>$${campaign.spend.toLocaleString()}</td>
                    <td>$${campaign.revenue.toLocaleString()}</td>
                    <td>
                        <span class="badge ${campaign.roi > 300 ? 'bg-success' : campaign.roi > 200 ? 'bg-warning' : 'bg-danger'}">
                            ${campaign.roi}%
                        </span>
                    </td>
                    <td>
                        <span class="badge ${campaign.status === 'Active' ? 'bg-success' : 'bg-secondary'}">
                            ${campaign.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editCampaign('${campaign.name}')">
                            ‚úèÔ∏è Edit
                        </button>
                    </td>
                </tr>
            `).join('');
        } else if (view === 'campaign') {
            tableSubtitle.textContent = `Detailed analysis of ${currentCampaign.name}`;
            tableBody.innerHTML = `
                <tr>
                    <td><strong>Campaign Period</strong></td>
                    <td colspan="7">${currentCampaign.startDate} to ${currentCampaign.endDate}</td>
                </tr>
                <tr>
                    <td><strong>Target Audience</strong></td>
                    <td>${currentCampaign.details.audience.size.toLocaleString()}</td>
                    <td><strong>Reached</strong></td>
                    <td>${currentCampaign.details.audience.reached.toLocaleString()}</td>
                    <td><strong>Reach Rate</strong></td>
                    <td colspan="3">${((currentCampaign.details.audience.reached / currentCampaign.details.audience.size) * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td><strong>Performance Metrics</strong></td>
                    <td colspan="7">
                        <div class="channel-pills">
                            ${Object.entries(currentCampaign.details.performance).map(([key, value]) => 
                                `<span class="channel-pill" style="background: #6c757d; color: white;">${key}: ${typeof value === 'number' ? value.toFixed(1) : value}</span>`
                            ).join('')}
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    // Get channel color
    function getChannelColor(channel) {
        const colors = {
            'Email': '#3498db',
            'Social': '#e74c3c',
            'Search': '#f39c12',
            'Content': '#27ae60',
            'Influencer': '#9b59b6'
        };
        return colors[channel] || '#6c757d';
    }

    // Go back to overview
    function goBack() {
        currentView = 'overview';
        currentCampaign = null;

        // Update breadcrumb
        document.getElementById('breadcrumb').innerHTML = '<li class="breadcrumb-item active">Marketing Overview</li>';

        // Update metrics
        updateMetrics();

        // Update charts
        renderCampaignsChart();
        updateTable('overview');
    }

    // Export data function
    function exportData() {
        alert('Export functionality would download current marketing performance data as CSV/Excel');
    }

    // Create new campaign
    function createNewCampaign() {
        alert('Create new campaign functionality would open a modal to configure campaign details');
    }

    // Edit campaign
    function editCampaign(campaignName) {
        alert(`Edit campaign functionality would open a modal to edit ${campaignName}`);
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
{% endblock %}
